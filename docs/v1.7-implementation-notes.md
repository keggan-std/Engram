# Engram v1.7.0 — Implementation Notes

> Audience: developers and AI agents picking up this codebase after v1.7.0 was shipped.
> Written so you can understand every change, where it lives, and why it was made.

---

## Branch

`feat/v1.7-token-efficiency` — branched from `main` at tag `v1.6.1` (commit `958f9b0`).

Merge target: `main`.

---

## Commit History (ordered)

| SHA (short) | Commit message summary                                                        | Files changed                                        |
| ----------- | ----------------------------------------------------------------------------- | ---------------------------------------------------- |
| `48f7a6a`   | fix(mcp)+perf(search)+feat(intelligence): P1.1+P1.3+P6.3                      | `src/constants.ts`, `src/tools/dispatcher-memory.ts` |
| `8fa0bb8`   | refactor+feat(session): P1.4+P2+P3+P5 — sessions.ts major rework              | `src/tools/sessions.ts`                              |
| `68ebc07`   | feat(catalog)+fix(lint): P2+P6.3+P6.4 — find.ts tiered catalog & smarter lint | `src/tools/find.ts`                                  |
| `f3239ab`   | feat(server): P4 -- --mode=universal / ENGRAM_MODE single-tool mode           | `src/index.ts`, `src/modes/universal.ts` (new)       |

> Note: `58e25b5` (`perf(response)`) was already in `main` / `HEAD` before this session — P1.2 (compact JSON + stripNulls) was implemented in a prior session and is not part of this branch's diff.

---

## Phase-by-Phase Notes

---

### P1.1 — Fix MCP Validation Crash

**File:** `src/tools/dispatcher-memory.ts`

**Problem:** Three input parameters on `engram_memory` were typed as `z.array(z.unknown())`. This generates a JSON Schema of `{"type": "array"}` with no `items` property. Some MCP clients (VS Code Copilot Mode, Cursor) validate tool input schemas strictly and reject tool calls with invalid schemas, producing a silent crash the agent cannot diagnose.

**Affected params:** `files` (in `set_file_notes_batch`, `begin_work`), `changes` (in `record_change`), `decisions` (in `record_decisions_batch`).

**Fix:** Each array was replaced with a fully specific Zod schema using `.passthrough()` on the object items. This generates valid `{"type": "array", "items": {"type": "object", ...}}` JSON Schema.

**Example (before → after):**

```typescript
// Before
files: z.array(z.unknown()).optional();

// After
files: z.array(
    z
        .object({
            file_path: z.string(),
            purpose: z.string().optional(),
            // ... all known fields
        })
        .passthrough(),
).optional();
```

**Side-effect:** The `begin_work` case in the action switch previously cast `params.files as string[]`. After the schema change, files are now objects. Fixed with:

```typescript
params.files as unknown as Array<string | Record<string, unknown>>;
```

---

### P1.2 — Compact JSON + Strip Nulls (pre-existing)

**File:** `src/response.ts`

**Status:** Already implemented in HEAD before this session (`58e25b5`). Not part of this branch's diff.

All `success()` / `error()` / `textResult()` responses use `JSON.stringify(data, stripNulls)` — a custom replacer that omits `null` and `undefined` values from output. Reduces payload size for sparse memory objects.

---

### P1.3 — Default Search Limit 20 → 8

**Files:** `src/constants.ts`, `src/tools/dispatcher-memory.ts`

Added:

```typescript
// src/constants.ts
export const DEFAULT_SEARCH_LIMIT = 8;
// 8 gives headroom for noise; 50 (max) is available via explicit limit param
```

In `dispatcher-memory.ts` search case, replaced hardcoded `20` with `DEFAULT_SEARCH_LIMIT`. The explicit `limit` param still allows up to `MAX_SEARCH_RESULTS = 50`.

**Rationale:** Typical agent lookups need 3-8 results. 20 results adds ~60% payload bloat for marginal value.

---

### P1.4 — Convention Capping by Verbosity

**File:** `src/tools/sessions.ts` (inside `registerSessionDispatcher()`, `case "start":`)

After `activeConventions` is fetched, conventions are:

1. Sorted: enforced-first (`enforced DESC`), then most-recent (`id DESC`)
2. Capped by verbosity level:

```typescript
const capConventions = (n: number) => activeConventions.slice(0, n);
const conventions =
    verbosity === "nano"
        ? capConventions(0)
        : verbosity === "minimal"
          ? capConventions(5)
          : verbosity === "summary"
            ? capConventions(10)
            : /* full */ activeConventions;
```

Response always includes `total_conventions: number` and (when capped) a hint message. Agents can fetch full list via `engram_memory(action:"get_conventions")` if needed.

---

### P2 — Tiered Tool Catalog

**Files:** `src/tools/find.ts`, `src/tools/sessions.ts`

**find.ts — `buildToolCatalog(tier: 0|1|2)`:**

Tier 0 (~80 tokens): Action names in a simple list.
Tier 1 (~400 tokens): Names + one-line descriptions, Markdown table.
Tier 2 (~1,200 tokens): Full parameter documentation (default for new agents).

`MEMORY_CATALOG` and `ADMIN_CATALOG` exported from `find.ts` for use by `universal.ts`.

**sessions.ts — `selectCatalogTier()` and `storeCatalogDelivery()`:**

```typescript
function selectCatalogTier(agent_name: string, verbosity: string): 0 | 1 | 2 {
    // Tier 0 if: nano verbosity
    // Tier 1 if: agent has received catalog before (stored in config table)
    // Tier 2 if: new agent or explicit full verbosity
}
```

`storeCatalogDelivery(agent_name)` writes the agent name + timestamp to the `config` table key `catalog_delivered_to`. On subsequent calls by the same agent, tier steps down automatically. Agents can always request a higher tier explicitly via `engram_find(action:"catalog", tier:2)`.

---

### P3 — Sub-Agent Session Mode

**File:** `src/tools/sessions.ts` (`case "start":`)

New parameters added to `inputSchema`:

- `agent_role: z.enum(["primary", "sub"]).optional()`
- `task_id: z.string().optional()`

When `agent_role === "sub"` is passed:

1. Fetch the specified task from `tasks` table.
2. Fetch files declared in `begin_work` for that task.
3. Fetch decisions that match the task's tags.
4. Fetch conventions capped to 5, enforced-first.
5. Return a compact object (no `previous_session`, no `agent_rules`, no `tool_catalog`, no broadcast checking).

Typical payload: ~300-500 tokens vs ~2,000+ for a full session start. Designed for sub-agents spawned as part of an orchestrated multi-agent workflow where the orchestrating agent holds the full context.

---

### P4 — Universal Mode (`--mode=universal` / `ENGRAM_MODE`)

**Files:** `src/index.ts`, `src/modes/universal.ts` (new file)

#### Activation (`src/index.ts`)

```typescript
import { registerUniversalMode } from "./modes/universal.js";

const args = process.argv.slice(2);
const universalMode =
    args.includes("--mode=universal") ||
    process.env.ENGRAM_MODE === "universal";

if (universalMode) {
    registerUniversalMode(server);
} else {
    registerSessionDispatcher(server);
    registerMemoryDispatcher(server);
    registerAdminDispatcher(server);
    registerFindTool(server);
}
```

Default behaviour is unchanged when the flag is absent.

#### Architecture (`src/modes/universal.ts`)

**`HandlerCapturer` class:**

All MCP SDK tool registrations call `server.tool(name, schema, handler)`. `HandlerCapturer` is a duck-typed stub that implements just enough of the SDK server interface to intercept those `tool()` calls and store the handler functions in a `Map<string, ToolHandler>`.

```typescript
class HandlerCapturer {
    private handlers = new Map<string, Function>();
    tool(name: string, _schema: unknown, handler: Function) {
        this.handlers.set(name, handler);
    }
    get(name: string) {
        return this.handlers.get(name);
    }
}
```

All 4 dispatcher registrations are run against a `HandlerCapturer` instead of the real server. This captures their handlers in-process with zero subprocess overhead.

**Routing:**

`SESSION_ACTIONS`, `MEMORY_ACTIONS`, `ADMIN_ACTIONS` Sets are built from the exported catalogs at module load. `resolveDispatcher(action)` does exact O(1) set lookup. `fuzzyResolveAction(action)` handles near-misses via BM25-style substring scoring with a 0.5 threshold.

**Response rewriting — `universalizeResponse(text)`:**

Any response text containing `engram_session(action:"X")`, `engram_memory(action:"X")`, etc. is rewritten to `engram({action:"X"})` so the agent doesn't get confused by inline examples referencing the old tool names.

**`discover` action:**

When `action: "discover"` is passed, returns a filtered version of the full tool catalog. Agents can use this to find the exact action name for anything without exiting the single-tool surface.

---

### P5 — Dead Code Removal

**File:** `src/tools/sessions.ts`

The function `registerSessionTools()` (lines 15–675 in v1.6.1) registered old v1.5 individual tools:

- `engram_start_session`
- `engram_end_session`
- `engram_pause_session`
- `engram_resume_session`
- `engram_record_change`
- `engram_get_file_notes`
- `engram_set_file_notes`
- `engram_add_convention`
- ... (dozens more)

These were replaced by the 4-dispatcher architecture in v1.6.0. The `registerSessionTools` export still existed in v1.6.1 but had zero call-sites anywhere in the codebase (confirmed by grep). It was deleted.

**Delta:** `sessions.ts` 904 lines → 316 lines (−588 lines net, −660 deleted + remaining additions from P1.4/P2/P3).

---

### P6.3 — `executive_summary` Nudge

**Files:** `src/tools/dispatcher-memory.ts`, `src/tools/find.ts`

**Dispatcher change:** After `set_file_notes` succeeds, if `params.executive_summary` was not provided, the response includes:

```json
{
    "success": true,
    "hint": "Consider adding an executive_summary (2-3 sentences) on the next write — it allows future sessions to understand this file without re-reading it."
}
```

**AR-06 in `find.ts`:** The `AGENT_RULES` constant was updated. Rule AR-06 now explicitly states: _"ALWAYS include `executive_summary` when calling `set_file_notes` or `set_file_notes_batch`. It is required, not optional."_

---

### P6.4 — Smarter Convention Linting

**File:** `src/tools/find.ts` (`case "lint":`)

**Before:** Convention text was split on whitespace. Each token was checked with `str.includes(token)` — matching substrings, causing many false positives (e.g. convention token `"use"` would match code containing `"reuse"`, `"overuse"`, etc.).

**After:**

1. **Backtick extraction:** Identifiers in `` `backticks` `` in the convention text are extracted first as high-priority tokens. These get exact symbol matching.

2. **Whole-word regex:** Non-backtick tokens are matched with `new RegExp('\\b' + token + '\\b', 'i')`. This prevents substring false positives.

3. **STOP_WORDS:** An expanded stop-word list (`the`, `a`, `an`, `is`, `are`, `should`, `must`, `all`, `when`, `use`, `do`, `not`, `with`, `for`, `in`, `of`, `to`, `be`, `it`, `as`, etc.) filters out meaningless tokens before scoring.

The result: significantly fewer false-positive convention violations, and much more reliable detection of genuine violations referencing specific identifiers.

---

## Token Impact Summary

| Change                                | Before           | After                 | Delta      |
| ------------------------------------- | ---------------- | --------------------- | ---------- |
| Session start — conventions (summary) | all conventions  | top 10 enforced-first | Up to −90% |
| Session start — conventions (nano)    | all conventions  | 0 (count only)        | −100%      |
| Tool catalog — returning agent        | ~1,200t (Tier 2) | ~80t (Tier 0)         | −93%       |
| `engram_memory(search)` default       | 20 results       | 8 results             | −60%       |
| Sub-agent session start               | ~2,000t+         | ~300-500t             | −80%       |
| Universal mode schema                 | 1,600t (4 tools) | ~80t (1 tool)         | −95%       |

---

## Testing

All changes covered by existing test suite.

```
✓ tests/repositories/repos.test.ts (38 tests)
✓ tests/repositories/batch.test.ts (9 tests)
✓ tests/installer/installer.test.ts (12 tests)
✓ tests/unit/normalize-path.test.ts (4 tests)

Total: 63 tests — all passing
```

Run tests: `npm test`
Build: `npm run build`

---

## What Was NOT Changed

- `src/response.ts` — compact JSON / `stripNulls` was already in HEAD at `58e25b5`. Not modified in this branch.
- `src/database.ts`, `src/migrations.ts` — no schema changes. All changes are behavioural.
- All repository files in `src/repositories/` — untouched.
- All service files in `src/services/` — untouched.
- `packages/` directory — thin client packages untouched.
- `tests/` — no test changes needed; all 63 pass against the new code.

---

## Known Limitations / Future Work

1. **`storeCatalogDelivery()`** uses the `config` table with a single key. If many distinct agents connect, the key accumulates agent names. Consider a dedicated `catalog_deliveries` table in v1.8.
2. **Sub-agent task scoping (P3)** requires `task_id` to already exist. There is no fallback if the task doesn't exist — callers should create the task with `engram_memory(action:"create_task")` first.
3. **Universal mode fuzzy resolver** has a fixed 0.5 score threshold. Very short action names (e.g. `"end"`) may not fuzzy-match well. The `discover` action is the reliable fallback.
4. **`registerSessionTools()` was deleted** but its TypeScript type exports (`SessionInput` etc.) were not explicitly removed. If anything outside this codebase imported those, it will break at compile time. Check consuming packages.
